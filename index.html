<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360 Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: #111; font-family: system-ui, -apple-system, sans-serif; overflow: hidden; }
        #panorama { width: 100%; height: 100%; }
        .controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 10; }
        
        /* עיצוב אחיד לכפתורים וללייבל */
        .action-btn { background: rgba(255, 255, 255, 0.9); border: none; padding: 12px 24px; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: 0.2s; color: #333; display: inline-block; text-align: center; }
        .action-btn:active { transform: scale(0.95); }
        #delete-btn { background: rgba(255, 60, 60, 0.9); color: white; }
        
        #file-input { display: none; }
        #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px; font-weight: bold; z-index: 20; display: none; background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="panorama"></div>
    <div id="loader">מעלה תמונה, אנא המתן...</div>

    <div class="controls">
        <label id="upload-label" class="action-btn">
            העלאת תמונה
            <input type="file" id="file-input" accept="image/*" />
        </label>
        <button id="share-btn" class="action-btn hidden">שיתוף</button>
        <button id="delete-btn" class="action-btn hidden">מחיקה</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

        let app, db, storage;
        
        try {
            // שים לב: הדבק את ההגדרות המדויקות שלך כאן ושמור על המבנה
            const firebaseConfig = {
            apiKey: "AIzaSyDzc2-dd4hUs05864kKgL6wjWjQdjvuWq0",
            authDomain: "pano-360-c4663.firebaseapp.com",
            projectId: "pano-360-c4663",
            storageBucket: "pano-360-c4663.firebasestorage.app",
            messagingSenderId: "344991277519",
            appId: "1:344991277519:web:4ff6ad6dc30e65fa4ff2ba"
        };

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch (err) {
            alert("שגיאה בהגדרת Firebase. ודא שהעתקת את ה-firebaseConfig נכון וללא טעויות תחביר.");
            console.error(err);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const imageId = urlParams.get('id');

        const elements = {
            panorama: document.getElementById('panorama'),
            fileInput: document.getElementById('file-input'),
            uploadLabel: document.getElementById('upload-label'),
            shareBtn: document.getElementById('share-btn'),
            deleteBtn: document.getElementById('delete-btn'),
            loader: document.getElementById('loader')
        };

        let currentStoragePath = null;

        async function initViewer() {
            if (imageId && db) {
                elements.uploadLabel.classList.add('hidden');
                elements.loader.innerText = "טוען תמונה...";
                elements.loader.style.display = "block";

                try {
                    const docRef = doc(db, "panoramas", imageId);
                    const docSnap = await getDoc(docRef);

                    elements.loader.style.display = "none";

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentStoragePath = data.storagePath;
                        
                        pannellum.viewer('panorama', {
                            "type": "equirectangular",
                            "panorama": data.imageUrl,
                            "autoLoad": true,
                            "compass": false,
                            "showControls": false
                        });

                        elements.shareBtn.classList.remove('hidden');
                        if (localStorage.getItem(`pano_owner_${imageId}`)) {
                            elements.deleteBtn.classList.remove('hidden');
                        }
                    } else {
                        alert('התמונה לא נמצאה או שנמחקה.');
                        window.location.href = window.location.pathname;
                    }
                } catch (error) {
                    console.error("Error fetching document:", error);
                    elements.loader.style.display = "none";
                    alert('שגיאה בטעינת התמונה.');
                }
            } else if (!imageId) {
                elements.panorama.innerHTML = '<div style="color:#666; display:flex; height:100%; align-items:center; justify-content:center; font-size:24px;">לחץ על העלאת תמונה כדי להתחיל</div>';
            }
        }

        elements.fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!storage || !db) {
                alert('החיבור ל-Firebase לא תקין, אנא רענן את העמוד.');
                return;
            }

            elements.loader.innerText = "מעלה תמונה, אנא המתן...";
            elements.loader.style.display = "block";
            elements.uploadLabel.classList.add('hidden');

            const fileExt = file.name.split('.').pop();
            const newId = Math.random().toString(36).substring(2) + Date.now().toString(36);
            const storagePath = `panoramas/${newId}.${fileExt}`;
            const storageRef = ref(storage, storagePath);

            try {
                // העלאה ל-Storage
                await uploadBytes(storageRef, file);
                const publicUrl = await getDownloadURL(storageRef);

                // שמירה ב-Firestore
                await setDoc(doc(db, "panoramas", newId), {
                    imageUrl: publicUrl,
                    storagePath: storagePath,
                    createdAt: new Date().toISOString()
                });

                // שמירת בעלות ב-LocalStorage ומעבר לדף
                localStorage.setItem(`pano_owner_${newId}`, 'true');
                window.location.href = `${window.location.pathname}?id=${newId}`;

            } catch (error) {
                console.error("Upload failed:", error);
                alert('שגיאה בהעלאה. בדוק את חוקי האבטחה (Rules) בפיירבייס.');
                elements.loader.style.display = "none";
                elements.uploadLabel.classList.remove('hidden');
            }
        });

        elements.shareBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(window.location.href);
                const originalText = elements.shareBtn.innerText;
                elements.shareBtn.innerText = "הקישור הועתק!";
                setTimeout(() => elements.shareBtn.innerText = originalText, 2000);
            } catch (err) {
                alert('שגיאה בהעתקת הקישור');
            }
        });

        elements.deleteBtn.addEventListener('click', async () => {
            if (!confirm('למחוק את התמונה? הפעולה בלתי הפיכה והקישור יפסיק לעבוד.')) return;

            elements.loader.innerText = "מוחק...";
            elements.loader.style.display = "block";

            try {
                if (currentStoragePath) {
                    const storageRef = ref(storage, currentStoragePath);
                    await deleteObject(storageRef);
                }
                await deleteDoc(doc(db, "panoramas", imageId));
                
                localStorage.removeItem(`pano_owner_${imageId}`);
                window.location.href = window.location.pathname;
            } catch (error) {
                console.error("Delete failed:", error);
                alert('שגיאה במחיקה.');
                elements.loader.style.display = "none";
            }
        });

        if(app) initViewer();
    </script>
</body>
</html>
